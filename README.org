#+TITLE:MPV
#+STARTUP: nohideblocks

[[https://mpv.io/manual/master/][official manual]], [[https://wiki.archlinux.org/title/mpv][arch mpv page]] (which i deem to b a *must-read*)

** Contents :TOC_3:noexport:
  - [[#installation][Installation]]
  - [[#scripts-added-user-scripts][Scripts added #user-scripts]]
    - [[#dbvol-docs][dbvol #docs]]
    - [[#blur-edges-docs][blur-edges #docs]]
    - [[#idea-subtitles][IDEA subtitles]]
    - [[#quack-docs][quack #docs]]
    - [[#reload-docs][reload #docs]]
    - [[#mpv-webtorrent-hook][mpv-webtorrent-hook]]
    - [[#undoredo][undoredo]]
    - [[#uosc][uosc]]
    - [[#thumbfast][thumbfast]]
    - [[#recents][recents]]
  - [[#shaders-added-user-shaders][Shaders added #user-shaders]]
    - [[#anime4k][Anime4K]]
  - [[#configuration][Configuration]]
    - [[#mpvconf][mpv.conf]]
    - [[#inputconf][input.conf]]
  - [[#to-do-list-08][To do list]]
    - [[#migrate-from-extended-menu-to-external-rofi][migrate from 'extended-menu' to external rofi]]
    - [[#plugin-bindings-04][plugin bindings]]
    - [[#viewtube-for-my-main-pc][viewtube for my main pc?]]
    - [[#hold-mpv-as-a-music-player][HOLD mpv as a music player]]
    - [[#idea-copy-paste-url][IDEA copy-paste-url]]
    - [[#idea-anime][IDEA Anime]]

** Installation
*Deps*: libsixel, lua52, sndio

** Scripts added [[https://github.com/mpv-player/mpv/wiki/User-Scripts][#user-scripts]]
*** [[file:scripts/dbvol.lua][dbvol]] [[https://gist.github.com/Artefact2/0a9c87d6d0f0ef6a565e44d830943fff][#docs]]
volume control using decibels, ~j/k~

*** TODO [[file:scripts/blur-edges.lua][blur-edges]] [[https://github.com/occivink/mpv-scripts#blur-edgeslua][#docs]]
kbd at the bottom of the script

*NOTE* slows everything down *a lot* + triggers only on fullscreen toggle

*** IDEA subtitles
either [[https://github.com/directorscut82/find_subtitles][this]] or [[https://github.com/davidde/mpv-autosub][this]]. Former - press to download, latter - automatic
also search on scripts page for 'sub-', there are lots of utility scripts for
working with subtitles

and yet another [[https://github.com/wiiaboo/mpv-scripts/blob/master/subit.lua][script]] for subtitles

**** IDEA when learning jap
[[https://github.com/linguisticmind/mpv-scripts/tree/master/copy-subtitle][copy-subtitle]]
and [[https://github.com/liberlanco/mpv-lang-learner][lang-learner]] as a must
and [[https://github.com/Ben-Kerman/immersive][immersive]] also for learning
[[https://github.com/fxmarty/rikai-mpv][rikay-mpv]] - special for jap
[[https://github.com/laelnasan/yomichampv][yomichampv]]
*** [[file:scripts/quack.lua][quack]] [[https://github.com/CounterPillow/mpv-quack][#docs]]
temporarily reduce the volume after a seek
*** [[file:scripts/reload.lua][reload]] [[https://github.com/4e6/mpv-reload][#docs]]
~ctrl+r~ to reload if anything is wrong / stuck
*** TODO [[https://github.com/noctuid/mpv-webtorrent-hook][mpv-webtorrent-hook]]
several deps, view installation section in docs
*** [[https://github.com/Eisa01/mpv-scripts#undoredo][undoredo]]
- mp.add_key_binding("u", "undo", undo)
- mp.add_key_binding("r", "redo", redo)
- mp.add_key_binding("U", "undoLoop", undoLoop)
*** [[https://github.com/tomasklaen/uosc][uosc]]
Feature-rich minimalist proximity-based UI for MPV player.

_Install / update_ with [[file:update-uosc]] script, then if its a fresh installation
[[https://github.com/tomasklaen/uosc/releases/latest/download/uosc.conf][copy]] uosc.conf to opts dir.
*** [[https://github.com/l-jared/thumbfast][thumbfast]]
High-performance on-the-fly thumbnailer for mpv.

*** TODO recents
take any script that SIMPLY logs history and pipe it to my extended-menu script

Example of line format in history.log file (see how it forms [[https://github.com/Eisa01/mpv-scripts#simplehistory][here]]):
: [Wednesday/September 06/09/2023 19:17:52] "output.lq.mp4" | https://dl4.vibio.tv/f064277c672d45c35a49426dca2020f7/2839/2839278/output.lq.mp4 | length=5367.4472335601 | time=5367.4100453432

** Shaders added [[https://github.com/mpv-player/mpv/wiki/User-Scripts#user-shaders][#user-shaders]]
*** [[https://github.com/bloc97/Anime4K/blob/master/GLSL_Instructions.md][Anime4K]]

** Configuration
*** mpv.conf
:PROPERTIES:
:header-args: :tangle mpv.conf
:END:

External Sources of this config:
- https://wiki.archlinux.org/title/mpv    <-- READ WHOLE
- https://github.com/hl2guide/better-mpv-config
- https://raw.githubusercontent.com/classicjazz/mpv-config/master/mpv.conf

#+begin_src conf
# DO NOT ALTER! This config is tangled from README
vo=gpu         # Uses GPU-accelerated video output by default.
profile=gpu-hq # Can cause performance problems with some GPU drivers and GPUs.
scale=ewa_lanczossharp
cscale=ewa_lanczossharp

border=no              # hides the window title bar

# term-osd-bar=yes     # displays a progress bar on the terminal
cursor-autohide=2000 # autohides the cursor after 1s

save-position-on-quit=yes

cache=yes # Uses a large seekable RAM cache even for local input.
# cache-secs=300
# Uses extra large RAM cache (needs cache=yes to make it useful).
demuxer-max-bytes=1800M
demuxer-max-back-bytes=1200M

# Sets the profile restore method to "copy if equal"
profile-restore=copy-equal
#+end_src

**** Motion Interpolation
Enabling those will significantly drop performance on my machine

#+begin_src conf :tangle no
# 3 settings below drop performance and make things laggy
# video-sync=display-resample
# interpolation
# tscale=oversample # smoothmotion
#+end_src

**** Audio
~volume=60~ - volume level to start with

#+begin_src conf
af-add='dynaudnorm=g=5:f=250:r=0.9:p=0.5' # Normalizes audio
af=scaletempo2
#+end_src

**** Color Space
#+begin_src conf
target-trc=auto
gamma-auto
vf=format=colorlevels=full:colormatrix=auto
video-output-levels=full
#+end_src

**** Dithering 
#+begin_src conf
dither-depth=auto
temporal-dither=yes
dither=fruit
#+end_src

**** Debanding 
#+begin_src conf
deband=yes          # enabled by default
deband-iterations=4 # deband steps
deband-threshold=48 # deband strength
deband-range=16     # deband range
deband-grain=48     # dynamic grain: set to "0" if using the static grain shader
#+end_src

**** Subtitles 
#+begin_src conf
blend-subtitles=yes
sub-auto=fuzzy # Enable fuzzy searching:
#+end_src
**** Plugins
***** UOSC
#+begin_src conf
# required so that the 2 UIs don't fight each other
osc=no
# uosc provides its own seeking/volume indicators, so you also don't need this
osd-bar=no
# uosc will draw its own window controls if you disable window border
border=no

# uosc respects this setting
# osd-font='Iosevka'

# And these doesn't
# osd-font-size=45
# osd-scale=0.5
#+end_src

**** My customs
#+begin_src conf
no-input-builtin-bindings
osd-font-size=45
#+end_src
**** Custom profiles ( must be last )
#+begin_src conf
[fastforward]
profile-restore=copy-equal
# scale=bilinear
# dscale=bilinear
# cscale=bilinear
vd-lavc-skiploopfilter=all
vd-lavc-skipframe=all
#+end_src

**** Inactive /mpv.conf/ settings
:PROPERTIES:
:header-args: :tangle no
:END:

Can fix stuttering in some cases, in other cases probably causes it. Try it if
you experience stuttering:

~opengl-early-flush=yes~

***** Anti-Ringing
#+begin_src conf
# scale-antiring=0.7  # luma upscale deringing
# dscale-antiring=0.7 # luma downscale deringing
# cscale-antiring=0.7 # chroma upscale deringing
#+end_src

***** Profiles
#+begin_src conf
# profile=svp

# [svp]
# input-ipc-server=/tmp/mpvsocket     # Receives input from SVP
# hr-seek-framedrop=no                # Fixes audio desync
# resume-playback=no                  # Not compatible with SVP
#+end_src

***** Upscaling & Processing
#+begin_src conf
# glsl-shaders-clr # luma upscaling
# note: any FSRCNNX above FSRCNNX_x2_8-0-4-1 is not worth the additional computional overhead
# glsl-shaders="~/.config/mpv/shaders/FSRCNNX_x2_8-0-4-1.glsl"
# scale=ewa_lanczos # luma downscaling
# note: ssimdownscaler is tuned for mitchell and downscaling=no
# glsl-shaders-append="~/.config/mpv/shaders/SSimDownscaler.glsl"
# dscale=mitchell
# linear-downscaling=no # chroma upscaling and downscaling
# glsl-shaders-append="~/.config/mpv/shaders/KrigBilateral.glsl"
# cscale=mitchell
# sigmoid-upscaling=yes
#+end_src

***** Custom Profiles
#+begin_src conf
[4k60] # 2160p @ 60fps (3840x2160 UHDTV)
profile-restore=copy-equal # Sets the profile restore method to "copy if equal"
profile-desc=4k60
profile-cond=((width ==3840 and height ==2160) and p["estimated-vf-fps"]>=31)
# deband=yes # necessary to avoid blue screen with KrigBilateral.glsl
deband=no # turn off debanding because presume wide color gamut
interpolation=no # turn off interpolation because presume 60fps
# UHD videos are already 4K so no luma upscaling is needed
# UHD videos are YUV420 so chroma upscaling is still needed
glsl-shaders-clr
# glsl-shaders="~/.config/mpv/shaders/KrigBilateral.glsl" # enable if your hardware can support it
interpolation=no # no motion interpolation required because 60fps is hardware ceiling
# no deinterlacer required because progressive

[4k30] # 2160p @ 24-30fps (3840x2160 UHDTV)
profile-restore=copy-equal # Sets the profile restore method to "copy if equal"
profile-desc=4k30
profile-cond=((width ==3840 and height ==2160) and p["estimated-vf-fps"]<31)
# deband=yes # necessary to avoid blue screen with KrigBilateral.glsl
deband=no # turn off debanding because presume wide color gamut
# UHD videos are already 4K so no luma upscaling is needed
# UHD videos are YUV420 so chroma upscaling is still needed
glsl-shaders-clr
# glsl-shaders="~/.config/mpv/shaders/KrigBilateral.glsl" # enable if your hardware can support it
# apply motion interpolation
# no deinterlacer required because progressive

[full-hd60] # 1080p @ 60fps (progressive ATSC)
profile-restore=copy-equal # Sets the profile restore method to "copy if equal"
profile-desc=full-hd60
profile-cond=((width ==1920 and height ==1080) and not p["video-frame-info/interlaced"] and p["estimated-vf-fps"]>=31)
# apply all luma and chroma upscaling and downscaling settings
interpolation=no # no motion interpolation required because 60fps is hardware ceiling
# no deinterlacer required because progressive

[full-hd30] # 1080p @ 24-30fps (NextGen TV/ATSC 3.0, progressive Blu-ray)
profile-restore=copy-equal # Sets the profile restore method to "copy if equal"
profile-desc=full-hd30
profile-cond=((width ==1920 and height ==1080) and not p["video-frame-info/interlaced"] and p["estimated-vf-fps"]<31)
# apply all luma and chroma upscaling and downscaling settings
# apply motion interpolation
# no deinterlacer required because progressive

[full-hd-interlaced] # 1080i @ 24-30fps (HDTV, interlaced Blu-rays)
profile-restore=copy-equal # Sets the profile restore method to "copy if equal"
profile-desc=full-hd-interlaced
profile-cond=((width ==1920 and height ==1080) and p["video-frame-info/interlaced"] and p["estimated-vf-fps"]<31)
# apply all luma and chroma upscaling and downscaling settings
# apply motion interpolation
vf=bwdif # apply FFMPEG's bwdif deinterlacer

[hd] # 720p @ 60 fps (HDTV, Blu-ray - progressive)
profile-restore=copy-equal # Sets the profile restore method to "copy if equal"
profile-desc=hd
profile-cond=(width ==1280 and height ==720)
# apply all luma and chroma upscaling and downscaling settings
interpolation=no # no motion interpolation required because 60fps is hardware ceiling
# no deinterlacer required because progressive

[sdtv-ntsc] # 640x480, 704x480, 720x480 @ 30fps (NTSC DVD - interlaced)
profile-restore=copy-equal # Sets the profile restore method to "copy if equal"
profile-desc=sdtv-ntsc
profile-cond=((width ==640 and height ==480) or (width ==704 and height ==480) or (width ==720 and height ==480))
# apply all luma and chroma upscaling and downscaling settings
# apply motion interpolation
vf=bwdif # apply FFMPEG's bwdif deinterlacer

[sdtv-pal] # 352x576, 480x576, 544x576, 720x576 @ 30fps (PAL broadcast or DVD - interlaced)
profile-restore=copy-equal # Sets the profile restore method to "copy if equal"
profile-desc=sdtv-pal
profile-cond=((width ==352 and height ==576) or (width ==480 and height ==576) or (width ==544 and height ==576) or (width ==720 and height ==576))
# apply all luma and chroma upscaling and downscaling settings
# apply motion interpolation
vf=bwdif # apply FFMPEG's bwdif deinterlacer

[default]
profile-restore=copy-equal # Sets the profile restore method to "copy if equal"
#+end_src

***** File Type Profiles
#+begin_src conf
# GIF Files
[extension.gif]
profile-restore=copy-equal # Sets the profile restore method to "copy if equal"
profile-desc=gif
cache=no
no-pause
loop-file=yes
# WebM Files
[extension.webm]
profile-restore=copy-equal # Sets the profile restore method to "copy if equal"
profile-desc=webm
no-pause
loop-file=yes
#+end_src
***** Protocol Specific Configuration
#+begin_src conf
[protocol.http]
profile-restore=copy-equal # Sets the profile restore method to "copy if equal"
profile-desc=http
hls-bitrate=max # use max quality for HLS streams
cache=yes
no-cache-pause # don't pause when the cache runs low

[protocol.https]
profile-restore=copy-equal # Sets the profile restore method to "copy if equal"
profile-desc=https
profile=protocol.http

[protocol.ytdl]
profile-restore=copy-equal # Sets the profile restore method to "copy if equal"
profile-desc=ytdl
profile=protocol.http
#+end_src

*** input.conf
:PROPERTIES:
:header-args: :tangle input.conf
:END:

[[https://github.com/mpv-player/mpv/blob/master/etc/input.conf][default keybindings]]

Use SHARP to assign the # key.

List of commands and further details: DOCS/man/input.rst
List of special keys: --input-keylist
Keybindings testing mode: mpv --input-test --force-window --idle

Use 'ignore' to unbind a key fully (e.g. 'ctrl+a ignore').

Strings need to be quoted and escaped:
  KEY show-text "This is a single backslash: \\ and a quote: \" !"

The default keybindings are hardcoded into the mpv binary.
You can disable them completely with: --no-input-default-bindings

Developer note:
On compilation, this file is baked into the mpv binary, and all lines are
uncommented (unless '#' is followed by a space) - thus this file defines the
default key bindings.

If this is enabled, treat all the following bindings as default:
#+begin_src conf
# THIS FILE IS BEING TANGLES FROM README

default-bindings start
#+end_src

*Note:* All key bindings below that are bound to ~_~ are defined as leader ones in
my leader script.

**** Playback
#+begin_src conf
# Seek units are in seconds, but note that these are limited by keyframes
l seek  5                          # seek 5 seconds forward
h seek -5                          # seek 5 seconds backward
RIGHT seek  5                          # seek 5 seconds forward
LEFT  seek -5                          # seek 5 seconds backward
# Do smaller, always exact (non-keyframe-limited), seeks with shift.
# Don't show them on the OSD (no-osd).
L no-osd seek  10 exact       # seek exactly 10 seconds forward
H no-osd seek -10 exact       # seek exactly 10 seconds backward

Ctrl+=     add video-zoom   0.1 # zoom in
Ctrl+-     add video-zoom  -0.1 # zoom out
# reset zoom and pan settings
Ctrl+0 set video-zoom 0 ; set video-pan-x 0 ; set video-pan-y 0

[ multiply speed 1/1.1 # decrease the playback speed
] multiply speed 1.1   # increase the playback speed
> multiply speed 2.0   # double the playback speed
< multiply speed 0.5   # halve the playback speed
0 set speed 1.0        # reset the speed to normal

SPACE cycle pause       # toggle pause/playback mode
PLAY cycle pause        # toggle pause/playback mode
PAUSE cycle pause       # toggle pause/playback mode
PLAYPAUSE cycle pause   # toggle pause/playback mode
PLAYONLY set pause no   # unpause
PAUSEONLY set pause yes # pause
#+end_src
**** Subtitles
Bind those if ya'll ever need 'em:
Shift+g add sub-scale +0.1             # increase the subtitle font size
Shift+f add sub-scale -0.1             # decrease the subtitle font size
Ctrl+Shift+LEFT sub-step -1            # change subtitle timing such that the previous subtitle is displayed
Ctrl+Shift+RIGHT sub-step 1            # change subtitle timing such that the next subtitle is displayed

**** Audio
#+begin_src conf
j add volume -2
k add volume 2
m cycle mute                           # toggle mute
#+end_src

**** Shaders
#+NAME: Anime4K
#+begin_src conf
CTRL+1 no-osd change-list glsl-shaders set "~~/shaders/Anime4K_Clamp_Highlights.glsl:~~/shaders/Anime4K_Restore_CNN_M.glsl:~~/shaders/Anime4K_Upscale_CNN_x2_M.glsl:~~/shaders/Anime4K_AutoDownscalePre_x2.glsl:~~/shaders/Anime4K_AutoDownscalePre_x4.glsl:~~/shaders/Anime4K_Upscale_CNN_x2_S.glsl"; show-text "Anime4K: Mode A (Fast)"
CTRL+2 no-osd change-list glsl-shaders set "~~/shaders/Anime4K_Clamp_Highlights.glsl:~~/shaders/Anime4K_Restore_CNN_Soft_M.glsl:~~/shaders/Anime4K_Upscale_CNN_x2_M.glsl:~~/shaders/Anime4K_AutoDownscalePre_x2.glsl:~~/shaders/Anime4K_AutoDownscalePre_x4.glsl:~~/shaders/Anime4K_Upscale_CNN_x2_S.glsl"; show-text "Anime4K: Mode B (Fast)"
CTRL+3 no-osd change-list glsl-shaders set "~~/shaders/Anime4K_Clamp_Highlights.glsl:~~/shaders/Anime4K_Upscale_Denoise_CNN_x2_M.glsl:~~/shaders/Anime4K_AutoDownscalePre_x2.glsl:~~/shaders/Anime4K_AutoDownscalePre_x4.glsl:~~/shaders/Anime4K_Upscale_CNN_x2_S.glsl"; show-text "Anime4K: Mode C (Fast)"
CTRL+4 no-osd change-list glsl-shaders set "~~/shaders/Anime4K_Clamp_Highlights.glsl:~~/shaders/Anime4K_Restore_CNN_M.glsl:~~/shaders/Anime4K_Upscale_CNN_x2_M.glsl:~~/shaders/Anime4K_Restore_CNN_S.glsl:~~/shaders/Anime4K_AutoDownscalePre_x2.glsl:~~/shaders/Anime4K_AutoDownscalePre_x4.glsl:~~/shaders/Anime4K_Upscale_CNN_x2_S.glsl"; show-text "Anime4K: Mode A+A (Fast)"
CTRL+5 no-osd change-list glsl-shaders set "~~/shaders/Anime4K_Clamp_Highlights.glsl:~~/shaders/Anime4K_Restore_CNN_Soft_M.glsl:~~/shaders/Anime4K_Upscale_CNN_x2_M.glsl:~~/shaders/Anime4K_AutoDownscalePre_x2.glsl:~~/shaders/Anime4K_AutoDownscalePre_x4.glsl:~~/shaders/Anime4K_Restore_CNN_Soft_S.glsl:~~/shaders/Anime4K_Upscale_CNN_x2_S.glsl"; show-text "Anime4K: Mode B+B (Fast)"
CTRL+6 no-osd change-list glsl-shaders set "~~/shaders/Anime4K_Clamp_Highlights.glsl:~~/shaders/Anime4K_Upscale_Denoise_CNN_x2_M.glsl:~~/shaders/Anime4K_AutoDownscalePre_x2.glsl:~~/shaders/Anime4K_AutoDownscalePre_x4.glsl:~~/shaders/Anime4K_Restore_CNN_S.glsl:~~/shaders/Anime4K_Upscale_CNN_x2_S.glsl"; show-text "Anime4K: Mode C+A (Fast)"
CTRL+0 no-osd change-list glsl-shaders clr ""; show-text "GLSL shaders cleared"
#+end_src

**** Misc
#+begin_src conf
# Quitting
# q quit
Q quit-watch-later # exit and remember the playback position
# q {encode} quit 4
ESC set fullscreen no                  # leave fullscreen
ESC {encode} quit 4

? show-progress                        # show playback progress
# toggle displaying information and statistics (https://mpv.io/manual/master/#stats)
i script-binding stats/display-stats-toggle 
` script-binding console/enable        # open the console
Ctrl+F cycle fullscreen                     # toggle fullscreen

Alt+v cycle video                          # switch video track
# cycle the video aspect ratio ("-1" is the container aspect)
Alt+Ctrl+v cycle-values video-aspect-override "16:9" "4:3" "2.35:1" "-1"

# take a screenshot of the video in its original resolution without subtitles
Ctrl+S screenshot video
#+end_src

** To do list [0/8]
*** TODO migrate from 'extended-menu' to external rofi
don't write a bicycle
*** TODO plugin bindings [0/4]
**** TODO dbvol kbds set somewhere
-mp.add_key_binding("j", "decrease-db", decrease_db, { repeatable = true })
-mp.add_key_binding("k", "increase-db", increase_db, { repeatable = true })
**** TODO toggle-blur command binding
-mp.add_key_binding("Alt+b", "toggle-blur", toggle)
**** TODO reload
mp.add_key_binding("Ctrl+r", "reload", reload)

OR

KEYBIND script-binding reload/reload
**** TODO undoredo
-mp.add_key_binding("u", "undo", undo)
--- mp.add_key_binding("ctrl+Z", "undoCaps", undo)
+mp.add_key_binding("ctrl+z", "undo", undo)
+mp.add_key_binding("ctrl+Z", "undoCaps", undo)

-mp.add_key_binding("r", "redo", redo)
--- mp.add_key_binding("ctrl+Y", "redoCaps", redo)
+mp.add_key_binding("ctrl+y", "redo", redo)
+mp.add_key_binding("ctrl+Y", "redoCaps", redo)

-mp.add_key_binding("U", "undoLoop", undoLoop)
--- mp.add_key_binding("ctrl+alt+Z", "undoLoopCaps", undoLoop)
+mp.add_key_binding("ctrl+alt+z", "undoLoop", undoLoop)
+mp.add_key_binding("ctrl+alt+Z", "undoLoopCaps", undoLoop)

*** TODO [[https://github.com/sebaro/ViewTube][viewtube]] for my main pc?
*** HOLD mpv as a music player
[[https://wiki.archlinux.org/title/mpv][this]] article also has a section called /Improving mpv as a music player with Lua
scripts/ which might b sometime useful again for my main pc
*** IDEA [[https://github.com/zenyd/mpv-scripts][copy-paste-url]]
*** IDEA Anime
https://github.com/ehoneyse/mpv-open-anilist-page
